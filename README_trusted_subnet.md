# Trusted Subnet Configuration

Этот документ описывает новую функциональность проверки доверенной подсети (trusted subnet) в системе сбора метрик.

## Обзор

Сервер может быть настроен на прием метрик только от агентов, IP-адреса которых находятся в указанной доверенной подсети. Это обеспечивает дополнительный уровень безопасности.

## Конфигурация сервера

### Флаг командной строки
```bash
./server -t "192.168.1.0/24"
```

### Переменная окружения
```bash
export TRUSTED_SUBNET="192.168.1.0/24"
./server
```

### Конфигурационный JSON файл (config.json)
```json
{
  "address": "localhost:8080",
  "store_interval": 300,
  "file_storage_path": "/tmp/metrics-db.json",
  "restore": true,
  "database_dsn": "",
  "key": "",
  "trusted_subnet": "192.168.1.0/24"
}
```

## Поведение

### Когда trusted_subnet задана
- Сервер проверяет заголовок `X-Real-IP` в каждом запросе
- IP-адрес должен находиться в указанной подсети CIDR
- Если IP не в подсети или заголовок отсутствует, возвращается статус 403 Forbidden

### Когда trusted_subnet пуста
- Проверка подсети отключена
- Метрики обрабатываются без дополнительных ограничений

## Примеры CIDR нотации

- `192.168.1.0/24` - подсеть 192.168.1.x (255 адресов)
- `10.0.0.0/8` - подсеть 10.x.x.x (16 миллионов адресов)
- `127.0.0.0/8` - локальная подсеть (localhost)
- `172.16.0.0/12` - приватная подсеть

## Агент

Агент автоматически определяет свой локальный IP-адрес и добавляет его в заголовок `X-Real-IP` при отправке метрик на сервер.

## Примеры использования

### Разрешить только локальные подключения
```bash
./server -t "127.0.0.0/8"
```

### Разрешить подключения из корпоративной сети
```bash
./server -t "192.168.0.0/16"
```

### Отключить проверку подсети
```bash
./server -t ""
# или
./server
```

## Статусы ответов

- `200 OK` - IP в доверенной подсети, запрос обработан
- `400 Bad Request` - Некорректный IP-адрес в заголовке X-Real-IP
- `403 Forbidden` - IP не в доверенной подсети или отсутствует заголовок X-Real-IP
- `500 Internal Server Error` - Некорректная конфигурация trusted_subnet 